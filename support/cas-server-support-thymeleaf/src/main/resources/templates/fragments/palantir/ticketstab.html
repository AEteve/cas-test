<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
</head>
<body>
<span th:fragment="main">
    <div class="attribute-tab w-100 d-none" id="attribute-tab-2">

        <form id="fmSearchTicket" class="d-block">
            <section class="cas-field form-group my-3 mdc-input-group d-flex">
                <div class="mdc-input-group-field mdc-input-group-field-append w-100">
                    <div id="ticketDefinitionsSelect" class="mdc-select mdc-select--outlined mdc-select--required mdc-menu-surface--fullwidth pb-2">
                        <div class="mdc-select__anchor"
                             role="button"
                             aria-required="true"
                             aria-haspopup="listbox"
                             aria-expanded="false">
                            <span class="mdc-line__ripple"></span>
                            <span class="mdc-notched-outline">
                                <span class="mdc-notched-outline__leading"></span>
                                <span class="mdc-notched-outline__notch">
                                    <span id="outlined-select-label" class="mdc-floating-label">Type</span>
                                </span>
                                <span class="mdc-notched-outline__trailing"></span>
                            </span>
                            <span class="mdc-select__selected-text-container">
                                <span class="mdc-select__selected-text"/>
                            </span>
                            <span class="mdc-select__dropdown-icon">
                                <svg class="mdc-select__dropdown-icon-graphic" viewBox="7 10 10 5" focusable="false">
                                    <polygon class="mdc-select__dropdown-icon-inactive" stroke="none"
                                             fill-rule="evenodd" points="7 10 12 15 17 10">
                                    </polygon>
                                    <polygon class="mdc-select__dropdown-icon-active" stroke="none"
                                             fill-rule="evenodd" points="7 15 12 10 17 15">
                                    </polygon>
                                </svg>
                            </span>
                            <span class="mdc-line-ripple"></span>
                        </div>
                        <div class="mdc-select__menu mdc-menu mdc-menu-surface mdc-menu-surface--fullwidth">
                            <ul id="ticketDefinitions" class="mdc-list" role="listbox">
                            </ul>
                        </div>
                    </div>
                    <label for="ticket"
                           class="mdc-text-field mdc-text-field--outlined control-label mdc-text-field--with-trailing-icon">
                        <span class="mdc-notched-outline">
                            <span class="mdc-notched-outline__leading"></span>
                            <span class="mdc-notched-outline__notch">
                                <span class="mdc-floating-label">Ticket</span>
                            </span>
                            <span class="mdc-notched-outline__trailing"></span>
                        </span>
                        <input class="mdc-text-field__input form-control" type="text"
                               name="ticket" tabindex="0" id="ticket" size="50" autocomplete="off" required/>
                    </label>

                    <div class="pt-2">
                        <div th:replace="~{fragments/switchbutton :: switchbutton (id='decodeTicket', label='screen.checkbox.decode.title')}"/>
                    </div>
                </div>
            </section>
            <div class="d-flex">
                <button id="searchTicketButton" class="mdc-button mdc-button--raised">
                    <span class="mdc-button__label"><i class="mdc-tab__icon mdi mdi-database-search" aria-hidden="true"></i>Search</span>
                </button>
                <button id="cleanTicketsButton" class="mdc-button mdc-button--raised">
                    <span class="mdc-button__label"><i class="mdc-tab__icon mdi mdi-broom" aria-hidden="true"></i>Clean</span>
                </button>
            </div>
        </form>
        <hr>
        <section class="my-3 d-flex h-350px">
              <pre class="ace-editor ace-relative w-100 h-100" id="ticketEditor"></pre>
        </section>
        <br/>
        <hr/>
        <h2>Ticket Catalog</h2>
        <table id="ticketCatalogTable" class="mdc-data-table__table table table-striped noborder">
            <thead>
            <tr class="mdc-data-table__header-row">
                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Type</th>
                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Field</th>
                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Value</th>
            </tr>
            </thead>
            <tbody class="mdc-data-table__content">
            </tbody>
        </table>
        
        <script type="text/javascript" th:inline="javascript">
            document.addEventListener("DOMContentLoaded", () => {

                const ticketEditor = initializeAceEditor("ticketEditor");
                ticketEditor.setReadOnly(true);

                let searchTicketButton = document.getElementById("searchTicketButton");
                searchTicketButton.addEventListener("click", event => {
                    const ticket = document.getElementById("ticket");
                    if (!ticket.checkValidity()) {
                        ticket.reportValidity();
                        return false;
                    }
                    const ticketId = $(ticket).val();
                    const type = $("#ticketDefinitions .mdc-list-item--selected").attr("data-value").trim();
                    if (ticket && type) {
                        const decode = new mdc.switchControl.MDCSwitch(document.getElementById("decodeTicketButton")).selected;
                        ticketEditor.setValue("");
                        $.get(`${casServerPrefix}/actuator/ticketRegistry/query?type=${type}&id=${ticketId}&decode=${decode}`,
                            response => {
                                ticketEditor.setValue(JSON.stringify(response, null, 2));
                                ticketEditor.gotoLine(1);
                            })
                            .fail((xhr, status, error) => {
                                console.error("Error fetching data:", error);
                            });
                    }
                    event.preventDefault();
                }, false);

                let cleanTicketsButton = document.getElementById("cleanTicketsButton");
                cleanTicketsButton.addEventListener("click", event => {
                    $.ajax({
                        url: `${casServerPrefix}/actuator/ticketRegistry/clean`,
                        type: 'DELETE',
                        success: response => {
                            ticketEditor.setValue(JSON.stringify(response, null, 2));
                            ticketEditor.gotoLine(1);
                        },
                        error: (xhr, status, error) => {
                            console.log(`Error: ${status} / ${error} / ${xhr.responseText}`);
                        }
                    });
                    event.preventDefault();
                }, false);


                $.get(`${casServerPrefix}/actuator/ticketRegistry/ticketCatalog`, response => {
                    console.log(response);
                    response.forEach(entry => {
                        let item = `
                            <li class="mdc-list-item" data-value='${entry.prefix}' role="option">
                                <span class="mdc-list-item__ripple"></span>
                                <span class="mdc-list-item__text">${entry.apiClass}</span>
                            </li>
                        `;
                        $("#ticketDefinitions").append($(item.trim()));
                    });
                    const ticketDefinitions = new mdc.select.MDCSelect(document.getElementById("ticketDefinitionsSelect"));
                    ticketDefinitions.selectedIndex = 0;
                }).fail((xhr, status, error) => {
                    console.error("Error fetching data:", error);
                });

                const groupColumn = 0;
                const ticketCatalogTable = $("#ticketCatalogTable").DataTable({
                    pageLength: 25,
                    columnDefs: [
                        { visible: false, targets: groupColumn }
                    ],

                    order: [groupColumn, 'desc'],
                    drawCallback: settings => {
                        $("#ticketCatalogTable tr").addClass("mdc-data-table__row");
                        $("#ticketCatalogTable td").addClass("mdc-data-table__cell");

                        const api = settings.api;
                        const rows = api.rows({ page: 'current' }).nodes();
                        let last = null;
                        api.column(groupColumn, { page: 'current' })
                            .data()
                            .each((group, i) => {
                                if (last !== group) {
                                    $(rows).eq(i).before(
                                        `<tr style='font-weight: bold; background-color:var(--cas-theme-primary); color:var(--mdc-text-button-label-text-color);'>
                                            <td colspan="2">${group}</td>
                                        </tr>`.trim());
                                    last = group;
                                }
                            });
                    }
                });

                $.get(`${casServerPrefix}/actuator/ticketRegistry/ticketCatalog`, response => {
                    console.log(response);
                    ticketCatalogTable.clear();
                    for (const definition of response) {
                        const flattened = flattenJSON(definition);
                        for (const [key, value] of Object.entries(flattened)) {
                            ticketCatalogTable.row.add({
                                0: `<code>${definition.prefix}</code>`,
                                1: `<code>${key}</code>`,
                                2: `<code>${value}</code>`
                            });
                        }
                    }
                    ticketCatalogTable.draw();
                }).fail((xhr, status, error) => {
                    console.error("Error fetching data:", error);
                });
                
            });
            </script>
    </div>
</span>
</body>
</html>
